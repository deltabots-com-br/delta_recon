<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center - Tactical View</title>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body {
            background: #0a0a0a;
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Grid Background */
        .bg-grid {
            background-image: linear-gradient(rgba(0, 255, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Video Wrapper - Enforce Square Aspect Ratio */
        .video-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
            position: relative;
            min-height: 0;
        }

        .video-wrapper {
            position: relative;
            height: 98%;
            aspect-ratio: 1 / 1;
            max-width: 100%;
            background: #000;
            border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Filters */
        .filter-night {
            filter: sepia(100%) hue-rotate(90deg) saturate(300%) contrast(1.2) brightness(1.1);
        }

        .filter-thermal {
            filter: grayscale(100%) contrast(150%) invert(100%) brightness(1.2);
        }

        .scanlines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0) 50%, rgba(0, 0, 0, 0.2) 50%, rgba(0, 0, 0, 0.2));
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 10;
        }

        .panel {
            background: rgba(10, 15, 10, 0.9);
            border: 1px solid #1f2937;
        }

        .btn-primary {
            background: #059669;
            color: #fff;
            padding: 0.5rem 1rem;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #10b981;
        }

        .btn-secondary {
            background: #1f2937;
            color: #9ca3af;
            border: 1px solid #374151;
            transition: all 0.2s;
        }

        .btn-secondary:hover,
        .btn-secondary.active {
            background: #059669;
            color: #fff;
            border-color: #059669;
        }

        input {
            background: #111;
            border: 1px solid #333;
            color: #0f0;
            padding: 0.5rem;
            outline: none;
        }

        input:focus {
            border-color: #059669;
        }

        #map {
            height: 100%;
            min-height: 200px;
            width: 100%;
            background: #111;
            border: 1px solid #333;
        }

        .leaflet-tile {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }

        .log-panel {
            height: 150px;
            border-top: 1px solid #1f2937;
            background: rgba(0, 0, 0, 0.95);
            padding: 0.5rem;
            font-size: 0.75rem;
            overflow-y: auto;
            font-family: 'Share Tech Mono', monospace;
        }
    </style>
</head>

<body class="bg-grid">
    <!-- Header -->
    <header class="bg-black border-b border-green-900 p-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <h1 class="text-xl font-bold text-green-500 tracking-widest">TACTICAL COMMAND CENTER</h1>
        </div>
        <div id="my-id" class="text-sm text-gray-400">INITIALIZING...</div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 p-2 gap-2 overflow-hidden">
        <!-- Sidebar -->
        <div class="w-80 flex flex-col gap-2">
            <!-- Connection Panel -->
            <div class="panel p-4 flex flex-col gap-2">
                <h2 class="text-xs text-gray-500 uppercase font-bold">Unit Uplink</h2>
                <input type="text" id="remoteId" placeholder="UNIT ID (e.g. OP-123)"
                    class="text-sm font-mono uppercase">
                <button onclick="connectToSoldier()" class="btn-primary text-sm uppercase tracking-wider">ESTABLISH
                    LINK</button>
            </div>

            <!-- Telemetry & Map Panel -->
            <div class="panel p-4 flex-1 flex flex-col gap-2">
                <h2 class="text-xs text-gray-500 uppercase font-bold mb-1">Telemetry</h2>
                <div class="grid grid-cols-2 gap-2 text-xs font-mono">
                    <div>
                        <div class="text-gray-500">BATTERY</div>
                        <div id="remote-bat" class="text-green-400 font-bold text-xl">--%</div>
                    </div>
                    <div>
                        <div class="text-gray-500">SIGNAL</div>
                        <div class="text-green-400 font-bold text-xl">STRONG</div>
                    </div>
                    <div class="col-span-2">
                        <div class="text-gray-500">GPS COORDS</div>
                        <div id="remote-gps" class="text-yellow-400 font-bold">WAITING DATA...</div>
                    </div>
                </div>

                <!-- Map Container -->
                <div id="map-container" class="flex-1 border border-gray-800 mt-2">
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- Main View -->
        <div class="flex-1 panel relative flex flex-col bg-black">
            <div
                class="absolute top-2 left-2 z-10 bg-black/50 px-2 py-1 text-xs text-green-400 border border-green-900 flex gap-2">
                <span>LIVE FEED: <span id="feed-status">OFFLINE</span></span>
                <span>DATA LINK: <span id="data-status">OFFLINE</span></span>
            </div>

            <!-- Video Container -->
            <div class="video-container">
                <div class="video-wrapper">
                    <div class="scanlines"></div>
                    <video id="remoteVideo" autoplay playsinline muted controls></video>

                    <!-- Manual Play Button -->
                    <div id="play-overlay"
                        class="absolute inset-0 flex items-center justify-center bg-black/80 z-20 hidden">
                        <button onclick="forcePlay()"
                            class="btn-primary text-xl px-6 py-3 border-2 border-green-500 animate-pulse">
                            CLICK TO ENABLE VIDEO FEED
                        </button>
                    </div>
                </div>
            </div>

            <!-- Video Controls -->
            <div class="flex justify-center gap-2 p-2 border-t border-green-900 bg-black/50">
                <button onclick="setFilter('normal')" id="btn-normal"
                    class="btn-secondary text-xs px-3 py-1 active">NORMAL</button>
                <button onclick="setFilter('night')" id="btn-night" class="btn-secondary text-xs px-3 py-1">NIGHT
                    VISION</button>
                <button onclick="setFilter('thermal')" id="btn-thermal"
                    class="btn-secondary text-xs px-3 py-1">THERMAL</button>
            </div>

            <!-- Mission Log -->
            <div class="log-panel flex flex-col">
                <div class="text-green-500 font-bold mb-1 sticky top-0 bg-black/90 p-1 border-b border-green-900">>>
                    MISSION LOG</div>
                <div id="status-log" class="space-y-1 text-gray-300">
                    <div>> SYSTEM READY</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const remoteVideo = document.getElementById('remoteVideo');
        const playOverlay = document.getElementById('play-overlay');
        const logEl = document.getElementById('status-log');
        const remoteIdInput = document.getElementById('remoteId');
        const myIdEl = document.getElementById('my-id');
        const feedStatus = document.getElementById('feed-status');
        const dataStatus = document.getElementById('data-status');
        const remoteBat = document.getElementById('remote-bat');
        const remoteGps = document.getElementById('remote-gps');

        let peer = null;
        let dataConn = null;
        let map = null;
        let marker = null;

        // Init Map
        function initMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }
        initMap();

        function updateMap(lat, lon) {
            if (!map) return;
            const pos = [lat, lon];
            if (!marker) {
                marker = L.marker(pos).addTo(map);
                map.setView(pos, 15);
            } else {
                marker.setLatLng(pos);
                map.setView(pos);
            }
        }

        function log(msg) {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            logEl.appendChild(div);
            logEl.parentElement.scrollTop = logEl.parentElement.scrollHeight;
        }

        function forcePlay() {
            remoteVideo.play().then(() => {
                playOverlay.classList.add('hidden');
                log('PLAYBACK STARTED MANUALLY');
            }).catch(e => {
                log('MANUAL PLAY ERROR: ' + e.message);
            });
        }

        function setFilter(type) {
            // Reset classes
            remoteVideo.className = '';

            // Update Buttons
            document.querySelectorAll('.btn-secondary').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + type).classList.add('active');

            if (type === 'night') {
                remoteVideo.classList.add('filter-night');
            } else if (type === 'thermal') {
                remoteVideo.classList.add('filter-thermal');
            }
        }

        // Init PeerJS
        const myId = "HQ-" + Math.floor(Math.random() * 100);
        peer = new Peer(myId);

        peer.on('open', (id) => {
            log('NETWORK INITIALIZED');
            myIdEl.innerText = "HQ ID: " + id;
        });

        peer.on('error', (err) => {
            console.error(err);
            log('ERROR: ' + err.type);
        });

        function connectToSoldier() {
            const destId = remoteIdInput.value.toUpperCase();
            if (!destId) {
                log('INVALID UNIT ID');
                return;
            }
            log('INITIATING UPLINK TO ' + destId + '...');

            // 1. Open Data Connection
            const conn = peer.connect(destId);
            conn.on('open', () => {
                log('DATA UPLINK ESTABLISHED');
                dataStatus.innerText = "ONLINE";
                dataStatus.classList.add('text-green-500');
                dataConn = conn;
            });

            conn.on('data', (data) => {
                if (data.type === 'LOG') {
                    log(data.payload);
                } else if (data.type === 'TELEMETRY') {
                    remoteBat.innerText = data.payload.bat + '%';
                    if (data.payload.lat !== 0) {
                        remoteGps.innerText = `${data.payload.lat}, ${data.payload.lon}`;
                        updateMap(data.payload.lat, data.payload.lon);
                    }
                }
            });

            conn.on('close', () => {
                log('DATA UPLINK LOST');
                dataStatus.innerText = "OFFLINE";
                dataStatus.classList.remove('text-green-500');
            });

            // 2. Call for Video (Send Dummy Silent Stream)
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, 640, 480);
            const stream = canvas.captureStream(10);

            // Add a silent audio track
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const dst = audioCtx.createMediaStreamDestination();
            const audioTrack = dst.stream.getAudioTracks()[0];
            stream.addTrack(audioTrack);

            log('SENDING SIGNAL...');
            const call = peer.call(destId, stream);
            setupCallEvents(call);
        }

        function setupCallEvents(call) {
            call.on('stream', (remoteStream) => {
                log('VIDEO STREAM EVENT FIRED');
                feedStatus.innerText = "ONLINE";
                feedStatus.classList.add('text-green-500');
                remoteVideo.srcObject = remoteStream;

                remoteVideo.play().catch(e => {
                    log('AUTOPLAY BLOCKED: ' + e.message);
                    playOverlay.classList.remove('hidden');
                });
            });

            call.on('close', () => {
                log('UPLINK TERMINATED');
                feedStatus.innerText = "OFFLINE";
                feedStatus.classList.remove('text-green-500');
                remoteVideo.srcObject = null;
            });
        }

        peer.on('call', (call) => {
            log('INCOMING CALL FROM UNIT');
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const stream = canvas.captureStream(10);
            call.answer(stream);
            setupCallEvents(call);
        });
    </script>
</body>

</html>
