<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center - Tactical View</title>
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body {
            background: #0a0a0a;
            color: #e0e0e0;
            font-family: 'Share Tech Mono', monospace;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Grid Background */
        .bg-grid {
            background-image: linear-gradient(rgba(0, 255, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .video-wrapper {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
            position: relative;
            width: 100%;
            height: 100%;
        }

        video {
            border: 1px solid #333;
            background: #000;
            /* Force Square Aspect Ratio */
            aspect-ratio: 1 / 1;
            height: 95%;
            width: auto;
            object-fit: cover;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.1);
        }

        .panel {
            background: rgba(10, 15, 10, 0.9);
            border: 1px solid #1f2937;
        }

        .btn-primary {
            background: #059669;
            color: #fff;
            padding: 0.5rem 1rem;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #10b981;
        }

        input {
            background: #111;
            border: 1px solid #333;
            color: #0f0;
            padding: 0.5rem;
            outline: none;
        }

        input:focus {
            border-color: #059669;
        }

        #map {
            height: 200px;
            width: 100%;
            background: #111;
            border: 1px solid #333;
            margin-top: 8px;
        }

        /* Custom Dark Map Tiles Filter */
        .leaflet-tile {
            filter: invert(100%) hue-rotate(180deg) brightness(95%) contrast(90%);
        }
    </style>
</head>

<body class="bg-grid">
    <!-- Header -->
    <header class="bg-black border-b border-green-900 p-3 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            <h1 class="text-xl font-bold text-green-500 tracking-widest">TACTICAL COMMAND CENTER</h1>
        </div>
        <div id="my-id" class="text-sm text-gray-400">INITIALIZING...</div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 p-2 gap-2 overflow-hidden">
        <!-- Sidebar -->
        <div class="w-80 flex flex-col gap-2">
            <!-- Connection Panel -->
            <div class="panel p-4 flex flex-col gap-2">
                <h2 class="text-xs text-gray-500 uppercase font-bold">Unit Uplink</h2>
                <input type="text" id="remoteId" placeholder="UNIT ID (e.g. OP-123)"
                    class="text-sm font-mono uppercase">
                <button onclick="connectToSoldier()" class="btn-primary text-sm uppercase tracking-wider">ESTABLISH
                    LINK</button>
            </div>

            <!-- Status Panel -->
            <div class="panel p-4 flex-1 flex flex-col gap-2">
                <h2 class="text-xs text-gray-500 uppercase font-bold mb-2">Mission Log</h2>
                <div id="status-log" class="text-xs font-mono space-y-1 text-gray-300 flex-1 overflow-y-auto h-32">
                    <div>> SYSTEM READY</div>
                </div>

                <!-- Telemetry Display -->
                <div class="border-t border-gray-800 pt-2 mt-2">
                    <h2 class="text-xs text-gray-500 uppercase font-bold mb-1">Telemetry</h2>
                    <div class="grid grid-cols-2 gap-2 text-xs font-mono">
                        <div>
                            <div class="text-gray-500">BATTERY</div>
                            <div id="remote-bat" class="text-green-400 font-bold text-xl">--%</div>
                        </div>
                        <div>
                            <div class="text-gray-500">SIGNAL</div>
                            <div class="text-green-400 font-bold text-xl">STRONG</div>
                        </div>
                        <div class="col-span-2">
                            <div class="text-gray-500">GPS COORDS</div>
                            <div id="remote-gps" class="text-yellow-400 font-bold">WAITING DATA...</div>
                        </div>
                    </div>

                    <!-- Map Container -->
                    <div id="map"></div>
                </div>
            </div>
        </div>

        <!-- Main View -->
        <div class="flex-1 panel relative flex flex-col bg-black">
            <div
                class="absolute top-2 left-2 z-10 bg-black/50 px-2 py-1 text-xs text-green-400 border border-green-900 flex gap-2">
                <span>LIVE FEED: <span id="feed-status">OFFLINE</span></span>
                <span>DATA LINK: <span id="data-status">OFFLINE</span></span>
            </div>

            <!-- Video Wrapper for Centering -->
            <div class="video-wrapper">
                <!-- Video Element with Muted for Autoplay -->
                <video id="remoteVideo" autoplay playsinline muted controls></video>

                <!-- Manual Play Button Overlay (Hidden by default) -->
                <div id="play-overlay"
                    class="absolute inset-0 flex items-center justify-center bg-black/80 z-20 hidden">
                    <button onclick="forcePlay()"
                        class="btn-primary text-xl px-6 py-3 border-2 border-green-500 animate-pulse">
                        CLICK TO ENABLE VIDEO FEED
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const remoteVideo = document.getElementById('remoteVideo');
        const playOverlay = document.getElementById('play-overlay');
        const logEl = document.getElementById('status-log');
        const remoteIdInput = document.getElementById('remoteId');
        const myIdEl = document.getElementById('my-id');
        const feedStatus = document.getElementById('feed-status');
        const dataStatus = document.getElementById('data-status');
        const remoteBat = document.getElementById('remote-bat');
        const remoteGps = document.getElementById('remote-gps');

        let peer = null;
        let dataConn = null;
        let map = null;
        let marker = null;

        // Init Map
        function initMap() {
            // Default to a neutral location or wait for GPS
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
        }
        initMap();

        function updateMap(lat, lon) {
            if (!map) return;
            const pos = [lat, lon];
            if (!marker) {
                marker = L.marker(pos).addTo(map);
                map.setView(pos, 15);
            } else {
                marker.setLatLng(pos);
                map.setView(pos); // Keep centered
            }
        }

        function log(msg) {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            logEl.appendChild(div);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function forcePlay() {
            remoteVideo.play().then(() => {
                playOverlay.classList.add('hidden');
                log('PLAYBACK STARTED MANUALLY');
            }).catch(e => {
                log('MANUAL PLAY ERROR: ' + e.message);
            });
        }

        // Init PeerJS
        const myId = "HQ-" + Math.floor(Math.random() * 100);
        peer = new Peer(myId);

        peer.on('open', (id) => {
            log('NETWORK INITIALIZED');
            myIdEl.innerText = "HQ ID: " + id;
        });

        peer.on('error', (err) => {
            console.error(err);
            log('ERROR: ' + err.type);
        });

        function setupCallEvents(call) {
            call.on('stream', (remoteStream) => {
                log('VIDEO STREAM EVENT FIRED');

                // Debug Stream Tracks
                const videoTracks = remoteStream.getVideoTracks();
                const audioTracks = remoteStream.getAudioTracks();

                log(`TRACKS: Video=${videoTracks.length}, Audio=${audioTracks.length}`);

                if (videoTracks.length > 0) {
                    const vTrack = videoTracks[0];
                    log(`V-TRACK: ${vTrack.label} | ${vTrack.readyState} | Enabled:${vTrack.enabled}`);

                    vTrack.onended = () => log('V-TRACK ENDED UNEXPECTEDLY');
                    vTrack.onmute = () => log('V-TRACK MUTED (Network issue?)');
                    vTrack.onunmute = () => log('V-TRACK UNMUTED');
                } else {
                    log('CRITICAL: NO VIDEO TRACK IN STREAM');
                }

                feedStatus.innerText = "ONLINE";
                feedStatus.classList.add('text-green-500');

                remoteVideo.srcObject = remoteStream;

                // Attempt autoplay
                const playPromise = remoteVideo.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        log('PLAYBACK PROMISE RESOLVED');
                    }).catch(error => {
                        log('AUTOPLAY ERROR: ' + error.message);
                        playOverlay.classList.remove('hidden');
                    });
                }
            });

            call.on('close', () => {
                log('UPLINK TERMINATED');
                feedStatus.innerText = "OFFLINE";
                feedStatus.classList.remove('text-green-500');
                remoteVideo.srcObject = null;
            });

            call.on('error', (err) => {
                log('CALL ERROR: ' + err);
            });
        }

        async function connectToSoldier() {
            const soldierId = remoteIdInput.value.trim();
            if (!soldierId) {
                alert("ENTER UNIT ID");
                return;
            }

            log('INITIATING UPLINK TO ' + soldierId + '...');

            // 1. Connect Data Channel
            dataConn = peer.connect(soldierId);

            if (dataConn) {
                dataConn.on('open', () => {
                    log('DATA CHANNEL SECURE');
                    dataStatus.innerText = "ONLINE";
                    dataStatus.classList.add('text-green-500');
                });

                dataConn.on('data', (data) => {
                    if (data.type === 'LOG') {
                        log(data.payload);
                    } else if (data.type === 'TELEMETRY') {
                        const t = data.payload;
                        remoteBat.innerText = t.bat + '%';
                        remoteGps.innerText = `${t.lat}, ${t.lon}`;
                        updateMap(t.lat, t.lon);
                    }
                });

                dataConn.on('close', () => {
                    log('DATA CHANNEL LOST');
                    dataStatus.innerText = "OFFLINE";
                    dataStatus.classList.remove('text-green-500');
                });

                dataConn.on('error', (err) => {
                    log('DATA ERROR: ' + err);
                });
            }

            // 2. Prepare Outgoing Stream (Audio + Dummy Video)
            // We MUST send a video track (even dummy) so the Soldier can answer with video.
            log('PREPARING UPLINK STREAM...');

            try {
                // Create Dummy Video (Canvas)
                const canvas = document.createElement('canvas');
                canvas.width = 640; canvas.height = 480;
                const ctx = canvas.getContext('2d');

                // Animate it slightly to ensure track stays active
                setInterval(() => {
                    ctx.fillStyle = Math.random() > 0.5 ? '#000' : '#111';
                    ctx.fillRect(0, 0, 640, 480);
                    ctx.fillStyle = '#0f0';
                    ctx.fillText("HQ UPLINK " + Date.now(), 10, 50);
                }, 1000);

                const canvasStream = canvas.captureStream(15);
                const videoTrack = canvasStream.getVideoTracks()[0];

                // Get Audio
                let audioStream;
                try {
                    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    log('MICROPHONE ACCESS GRANTED');
                } catch (e) {
                    log('MIC FAILED: ' + e.message);
                    // Continue without audio
                }

                // Combine
                const finalStream = new MediaStream();
                finalStream.addTrack(videoTrack);
                if (audioStream) {
                    audioStream.getAudioTracks().forEach(t => finalStream.addTrack(t));
                }

                // Call
                log('SENDING UPLINK SIGNAL...');
                const call = peer.call(soldierId, finalStream);
                setupCallEvents(call);

            } catch (err) {
                log('CRITICAL STREAM ERROR: ' + err.message);
            }
        }
    </script>
</body>

</html>
